@using Models
@using Models.ViewModel.Group

@model List<Group?>
@{
    ViewData["Title"] = "Danh sách nhóm của tôi";
    var loggedInUserId = (int?)ViewBag.LoggedInUserId;
}

<main id="site__main" class="2xl:ml-[--w-side] xl:ml-[--w-side-sm] p-2.5 h-[calc(100vh-var(--m-top))] mt-[--m-top]">
    <div class="lg:flex 2xl:gap-16 gap-12 max-w-[1065px] mx-auto" style="background-color:rgb(249, 250, 251)">
        <div class="max-w-[680px] mx-auto w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Nhóm của tôi</h2>

            <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mb-6" uk-toggle="target: #create-group-modal">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Tạo nhóm mới
            </button>

            @if (Model != null && Model.Any())
            {
                <div class="flex flex-col gap-4">
                    @foreach (var group in Model)
                    {
                        if (group != null)
                        {
                            <div class="bg-white rounded-xl shadow-md overflow-hidden flex items-center">
                                <div class="p-4 flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2 truncate">
                                        <a href="/Group/Details/@group.ID" class="hover:text-blue-600">@group.GroupName</a>
                                    </h3>
                                    <p class="text-sm text-gray-500 mb-2">
                                        <i class="fas fa-users mr-1"></i>
                                        @if (group.IsPrivate)
                                        {
                                            <span class="ml-1 text-red-500 font-medium">Nhóm riêng tư</span>
                                        }
                                        else
                                        {
                                            <span class="ml-1 text-green-500 font-medium">Nhóm công khai</span>
                                        }
                                    </p>
                                    <p class="text-xs text-gray-400">Ngày tạo: @group.CreatedDate.ToShortDateString()</p>

                                    <div class="mt-4 flex items-center space-x-3">
                                        <a href="/Group/Details/@group.ID" class="inline-block px-3 py-1.5 text-sm font-medium rounded-md text-blue-600 border border-blue-600 hover:bg-blue-50">Xem chi tiết</a>

                                        @if (group.CreatedByUserId == loggedInUserId)
                                        {
                                            @* Đã đổi tên hàm và loại bỏ logic modal UIkit *@
                                            <button type="button" onclick="deleteGroupConfirmation('@group.ID')"
                                                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                Xóa nhóm
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" onclick="leaveGroup('@group.ID')"
                                                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1m-6-1V7a2 2 012-2h4a2 2 0 012 2v10a2 2 0 01-2 2h-4a2 2 0 01-2-2z" />
                                                </svg>
                                                Rời nhóm
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            }
            else
            {
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                    <p class="font-bold">Chưa có nhóm nào</p>
                    <p>Bạn chưa tham gia hoặc tạo bất kỳ nhóm nào. Hãy **tạo nhóm mới** để bắt đầu!</p>
                </div>
            }
        </div>
    </div>
</main>

<div id="create-group-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body uk-margin-auto-vertical rounded-xl p-0 md:w-[600px] 2xl:w-[700px]">
        <button class="uk-modal-close-default m-4" type="button" uk-close></button>
        @await Html.PartialAsync("_CreateGroup", new Models.ViewModel.Group.CreateGroupForm())
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        function showSwalAlert(message, isSuccess, callback = null) {
            Swal.fire({
                icon: isSuccess ? 'success' : 'error',
                title: isSuccess ? 'Thành công' : 'Thất bại',
                text: message,
                confirmButtonText: 'Đóng',
                // Tự động gọi callback (thường là reload/redirect) sau khi đóng popup nếu thành công
                didClose: () => {
                    if (callback) {
                        callback();
                    }
                }
            });
        }

        // --- Logic Xóa Nhóm (Chỉ Chủ nhóm) dùng Swal.fire ---
        window.deleteGroupConfirmation = function (groupId) {
            Swal.fire({
                title: 'CẢNH BÁO: Xóa nhóm',
                text: "Bạn có chắc chắn muốn xóa nhóm này không? Thao tác này không thể hoàn tác!",
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa nhóm vĩnh viễn',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/Group/DeleteGroup', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(parseInt(groupId))
                    })
                    .then(res => res.json())
                    .then(data => {
                        const isSuccess = data.Status; // Giả sử API trả về Status/Mess
                        showSwalAlert(data.Mess || (isSuccess ? "Nhóm đã được xóa thành công!" : "Không thể xóa nhóm."), isSuccess, () => {
                            // Tải lại trang để cập nhật danh sách hoặc chuyển hướng
                            if (isSuccess) window.location.href = '/Group';
                        });
                    })
                    .catch(() => showSwalAlert("Đã xảy ra lỗi hệ thống khi xóa nhóm.", false));
                }
            });
        };

        // --- Logic Rời Nhóm dùng Swal.fire ---
        window.leaveGroup = function(groupId) {
            Swal.fire({
                title: 'Xác nhận Rời nhóm',
                text: "Bạn có chắc chắn muốn rời nhóm này không?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Rời nhóm',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/GroupMember/LeaveGroup', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(parseInt(groupId))
                    })
                    .then(response => response.json())
                    .then(data => {
                        const isSuccess = data.Status;
                        showSwalAlert(data.Mess || (isSuccess ? 'Rời nhóm thành công!' : 'Rời nhóm không thành công.'), isSuccess, () => {
                            if (isSuccess) window.location.reload();
                        });
                    })
                    .catch(() => showSwalAlert('Đã xảy ra lỗi hệ thống khi rời nhóm. Vui lòng thử lại.', false));
                }
            });
        };

        document.addEventListener('DOMContentLoaded', function () {
            // --- Hiển thị thông báo TempData bằng SweetAlert2 ---
            var successMessage = '@TempData["Success"]';
            var errorMessage = '@TempData["Error"]';

            // Không cần kiểm tra null/empty ở đây vì Razor/C# đã xử lý string, chỉ cần kiểm tra xem có nội dung hay không
            if (successMessage) {
                showSwalAlert(successMessage, true);
            }

            if (errorMessage) {
                showSwalAlert(errorMessage, false);
            }
        });
    </script>
}