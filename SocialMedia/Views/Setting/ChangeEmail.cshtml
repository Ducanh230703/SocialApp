@{
    ViewData["Title"] = "Change Email";
}

<div class="max-w-md mx-auto mt-10 bg-white p-6 shadow-lg rounded-lg">
    <h2 class="text-xl font-semibold mb-4">📧 Thay đổi email</h2>

    <form id="changeEmailForm" class="space-y-4">
        <div>
            <label class="block text-sm text-gray-700 mb-1">Email hiện tại</label>
            <input type="email" name="CurrentEmail" class="w-full border rounded-md p-2" required />
        </div>

        <div>
            <label class="block text-sm text-gray-700 mb-1">Email mới</label>
            <input type="email" name="NewEmail" class="w-full border rounded-md p-2" required />
        </div>

        <div class="flex justify-end space-x-3">
            <a asp-controller="Setting" asp-action="Index"
               class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Hủy</a>
            <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Lưu thay đổi
            </button>
        </div>
    </form>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Hiển thị popup
    function showPopup(title, message, icon = "success") {
        return Swal.fire({
            title: title,
            text: message,
            icon: icon,
            confirmButtonText: "OK",
            confirmButtonColor: "#2563eb"
        });
    }

    // Hiển thị popup nhập OTP
    async function showOTPModal(newEmail) {
        const { value: otp } = await Swal.fire({
            title: "Nhập mã xác nhận OTP",
            input: "text",
            inputPlaceholder: "Nhập mã OTP đã gửi đến " + newEmail,
            inputAttributes: { maxlength: 6, autocapitalize: "off", autocorrect: "off" },
            showCancelButton: true,
            confirmButtonText: "Xác nhận",
            confirmButtonColor: "#2563eb",
            cancelButtonText: "Hủy"
        });

        if (otp) {
            verifyOTP(newEmail, otp);
        }
    }

    // Xác thực OTP
    async function verifyOTP(newEmail, otp) {
        const response = await fetch("/User/VerifyChangeEmail", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ NewEmail: newEmail, OtpCode: otp })
        });

        const result = await response.json();

        if (result.status === 1) {
            showPopup("🎉 Thành công", result.mess || "Email đã được thay đổi!");
        } else {
            showPopup("❌ Lỗi", result.mess || "Mã OTP không hợp lệ!", "error");
        }
    }

    // Gửi yêu cầu đổi email
    document.getElementById("changeEmailForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        const response = await fetch("/User/ChangeEmail", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 1) {
            // Gửi OTP thành công → mở modal nhập OTP
            showPopup("Gửi mã OTP thành công", "Vui lòng kiểm tra email mới của bạn.")
                .then(() => showOTPModal(data.NewEmail));
        } else {
            showPopup("Lỗi", result.mess || "Không thể gửi OTP!", "error");
        }
    });
</script>
