@using Models.ViewModel.Users
@model EditInfo

@{
    ViewData["Title"] = "Thông tin tài khoản của tôi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<main id="site__main" class="2xl:ml-[--w-side] xl:ml-[--w-side-sm] p-2.5 h-[calc(100vh-var(--m-top))] mt-[--m-top]">
    <div class="container mx-auto p-4 mt-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-center">Cập nhật thông tin cá nhân</h2>

            <form id="avatar-update-form" class="mb-8">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-24 h-24 rounded-full overflow-hidden mb-4">
                        <img src="@(string.IsNullOrEmpty(Model?.ProfilePictureUrl) ? Url.Content("~/images/avatar/user.png") : Model?.ProfilePictureUrl)"
                             alt="Avatar"
                             class="w-full h-full object-cover"
                             id="avatar-preview-display">
                    </div>
                    <input type="file" id="avatar-upload" name="ProfilePictureFile" accept="image/*" class="hidden">
                    <label for="avatar-upload" class="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                        Chọn ảnh đại diện
                    </label>
                    <button type="submit" id="save-avatar-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mt-4" style="display:none;">
                        Lưu ảnh
                    </button>
                    <button type="button" id="cancel-avatar-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mt-2" style="display:none;">
                        Hủy
                    </button>
                </div>
            </form>

            <form id="info-update-form">
                <div class="mb-4">
                    <label for="fullName" class="block text-gray-700 text-sm font-bold mb-2">Họ và tên:</label>
                    <input type="text" id="fullName" name="FullName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="@Model?.FullName">
                </div>

                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" name="Email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="@Model?.Email">
                </div>

                <div class="mb-6">
                    <label for="bio" class="block text-gray-700 text-sm font-bold mb-2">Tiểu sử:</label>
                    <textarea id="bio" name="Bio" rows="4" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline resize-none">@Model?.Bio</textarea>
                </div>

                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Lưu thông tin
                    </button>
                    <button type="button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

@section Scripts {
        <script>
    document.addEventListener('DOMContentLoaded', function () {
        // === Khai báo các phần tử và biến cần thiết ===
        const avatarUpload = document.getElementById('avatar-upload');
        const avatarPreviewDisplay = document.getElementById('avatar-preview-display');
        const saveAvatarButton = document.getElementById('save-avatar-button');
        const cancelAvatarButton = document.getElementById('cancel-avatar-button');
        const avatarUpdateForm = document.getElementById('avatar-update-form');
        const infoUpdateForm = document.getElementById('info-update-form');

        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const bioInput = document.getElementById('bio');

        // Lấy URL ảnh đại diện hiện tại
        let currentProfilePictureUrl = avatarPreviewDisplay ? avatarPreviewDisplay.src : '';
        if (currentProfilePictureUrl && currentProfilePictureUrl.startsWith(window.location.origin)) {
            currentProfilePictureUrl = currentProfilePictureUrl.substring(window.location.origin.length);
        }
        const defaultAvatarUrl = "@Url.Content("~/images/avatar/user.png")";
        if (!currentProfilePictureUrl || currentProfilePictureUrl.trim() === "") {
            currentProfilePictureUrl = defaultAvatarUrl;
        }
        let originalAvatarSrc = avatarPreviewDisplay ? avatarPreviewDisplay.src : ''; 

        function showAlert(title, text, icon = 'success') {
            if (typeof Swal === 'undefined') {
                console.error('SweetAlert2 (Swal) không được tìm thấy. Vui lòng nhúng thư viện.');
                alert(`${icon.toUpperCase()}: ${title}\n${text}`);
                return;
            }

            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: 'Đóng'
            });
        }

        // --- Hàm reset trạng thái validation (nếu có CSS cho is-invalid) ---
        function resetValidationState(inputElement) {
            inputElement.classList.remove('is-invalid');
            // ... (xóa thông báo lỗi cụ thể bên dưới input nếu có)
        }

        // --- Hàm hiển thị lỗi validation cho input cụ thể ---
        function setInvalidState(inputElement) { 
            inputElement.classList.add('is-invalid');
            // ... (đặt thông báo lỗi cụ thể bên dưới input nếu có)
        }

        // --- Xử lý Avatar Update: Preview và Buttons ---
        if (avatarUpload && avatarPreviewDisplay) {
            avatarUpload.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        avatarPreviewDisplay.src = e.target.result;
                        saveAvatarButton.style.display = 'block';
                        cancelAvatarButton.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    avatarPreviewDisplay.src = originalAvatarSrc;
                    saveAvatarButton.style.display = 'none';
                    cancelAvatarButton.style.display = 'none';
                }
            });
        }

        if (cancelAvatarButton) {
            cancelAvatarButton.addEventListener('click', function () {
                avatarPreviewDisplay.src = originalAvatarSrc;
                avatarUpload.value = '';
                saveAvatarButton.style.display = 'none';
                cancelAvatarButton.style.display = 'none';
            });
        }

        // --- Xử lý Avatar Update: Gửi Form ---
        if (avatarUpdateForm) {
            avatarUpdateForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const avatarFile = avatarUpload.files[0];
                const submitButton = saveAvatarButton;
                submitButton.disabled = true; // Vô hiệu hóa nút

                if (!avatarFile) {
                    showAlert("Cảnh báo", "Vui lòng chọn ảnh để cập nhật.", 'warning');
                    submitButton.disabled = false;
                    return;
                }
                
                const formData = new FormData();
                formData.append('image', avatarFile);
                formData.append('removeUrl', currentProfilePictureUrl);

                try {
                    const response = await fetch('@Url.Action("UpAvatar", "User")', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 1) {
                            // SỬ DỤNG SWAL.FIRE
                            showAlert("Thành công! 🎉", result.mess || "Cập nhật ảnh đại diện thành công!", 'success');

                            if (result.data) {
                                avatarPreviewDisplay.src = result.data;
                                currentProfilePictureUrl = result.data;
                                originalAvatarSrc = result.data;
                            }
                            // Reset trạng thái
                            saveAvatarButton.style.display = 'none';
                            cancelAvatarButton.style.display = 'none';
                            avatarUpload.value = '';
                        } else {
                            let serverErrorMessage = result.mess || 'Lỗi không xác định từ server.';
                            if (result.errors && result.errors.length > 0) {
                                serverErrorMessage += '\n' + result.errors.join('\n');
                            }
                            // SỬ DỤNG SWAL.FIRE
                            showAlert("Thất bại!", 'Cập nhật ảnh đại diện thất bại: ' + serverErrorMessage, 'error');
                            avatarPreviewDisplay.src = originalAvatarSrc; // Khôi phục ảnh gốc
                        }
                    } else {
                        const errorText = await response.text();
                        // SỬ DỤNG SWAL.FIRE
                        showAlert("Lỗi Server!", `Lỗi server khi cập nhật ảnh đại diện (${response.status}): ${errorText}`, 'error');
                    }
                } catch (error) {
                    console.error('Lỗi khi cập nhật ảnh đại diện:', error);
                    // SỬ DỤNG SWAL.FIRE
                    showAlert("Lỗi Kết nối!", "Đã xảy ra lỗi kết nối khi cập nhật ảnh đại diện.", 'error');
                } finally {
                    submitButton.disabled = false; // Kích hoạt lại nút
                }
            });
        }

        // --- Xử lý Edit Info: Gửi Form ---
        if (infoUpdateForm) {
            infoUpdateForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const submitButton = infoUpdateForm.querySelector('button[type="submit"]');
                submitButton.disabled = true; // Vô hiệu hóa nút

                const fullName = fullNameInput.value.trim();
                const email = emailInput.value.trim();
                const bio = bioInput.value.trim();

                // --- VALIDATE CLIENT-SIDE ---
                let isValid = true;
                let errorMessages = [];

                // Reset validation states
                resetValidationState(fullNameInput);
                resetValidationState(emailInput);

                // Validate FullName
                if (!fullName) {
                    isValid = false;
                    errorMessages.push('Họ và tên không được để trống.');
                    setInvalidState(fullNameInput);
                } else if (fullName.length < 3 || fullName.length > 100) {
                    isValid = false;
                    errorMessages.push('Họ và tên phải có ít nhất 3 ký tự và không quá 100 ký tự.');
                    setInvalidState(fullNameInput);
                }

                // Validate Email 
                    const emailRegex = @Html.Raw(" /^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$/ "); // Chú ý các dấu '\' phải được escape trong C# string literal
                        if (!email) {
                    isValid = false;
                    errorMessages.push('Email không được để trống.');
                    setInvalidState(emailInput);
                } else if (!emailRegex.test(email)) {
                    isValid = false;
                    errorMessages.push('Địa chỉ email không hợp lệ.');
                    setInvalidState(emailInput);
                } else if (email.length > 100) {
                    isValid = false;
                    errorMessages.push('Email không được quá 100 ký tự.');
                    setInvalidState(emailInput);
                }
                
                // Validate Bio (Ví dụ: giới hạn 500 ký tự)
                if (bio.length > 500) {
                    isValid = false;
                    errorMessages.push('Tiểu sử không được quá 500 ký tự.');
                    setInvalidState(bioInput);
                }


                if (!isValid) {
                    // SỬ DỤNG SWAL.FIRE
                    showAlert("Lỗi nhập liệu", errorMessages.join('<br/>'), 'error');
                    submitButton.disabled = false;
                    return; 
                }
                // --- KẾT THÚC VALIDATE CLIENT-SIDE ---

                // Chuẩn bị dữ liệu để gửi dưới dạng FormData
                const editInfoFormData = new FormData();
                editInfoFormData.append('FullName', fullName);
                editInfoFormData.append('Email', email);
                editInfoFormData.append('Bio', bio);
                
                try {
                    const response = await fetch('@Url.Action("EditInfo", "User")', {
                        method: 'POST',
                        body: editInfoFormData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 1) {
                            // SỬ DỤNG SWAL.FIRE
                            showAlert("Thành công! 🎉", result.mess || "Cập nhật thông tin cá nhân thành công!", 'success');
                            // Có thể cập nhật lại giá trị input nếu cần
                        } else {
                            let serverErrorMessage = result.mess || 'Lỗi không xác định từ server.';
                            if (result.errors && result.errors.length > 0) {
                                serverErrorMessage += '\n' + result.errors.join('\n');
                            }
                            // SỬ DỤNG SWAL.FIRE
                            showAlert("Thất bại!", 'Cập nhật thông tin cá nhân thất bại: ' + serverErrorMessage, 'error');
                        }
                    } else {
                        let errorResult;
                        try {
                            errorResult = await response.json();
                        } catch (e) {
                            errorResult = { mess: await response.text() };
                        }

                        let errorMessage = 'Lỗi server khi cập nhật: ' + (errorResult.mess || 'Lỗi không xác định.');
                        if (errorResult.errors && errorResult.errors.length > 0) {
                            errorMessage += '\n' + errorResult.errors.join('\n');
                        }
                        // SỬ DỤNG SWAL.FIRE
                        showAlert("Lỗi Server!", errorMessage, 'error');
                    }
                } catch (error) {
                    console.error('Lỗi khi cập nhật thông tin cá nhân:', error);
                    // SỬ DỤNG SWAL.FIRE
                    showAlert("Lỗi Kết nối!", "Đã xảy ra lỗi khi cập nhật thông tin cá nhân.", 'error');
                } finally {
                    submitButton.disabled = false; // Kích hoạt lại nút
                }
            });
        }
    });
    </script>
}