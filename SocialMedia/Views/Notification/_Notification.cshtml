@using Models
@using Models.ReponseModel
@model PaginatedResponse<Notification>

@{
    var notifications = Model?.Data ?? new List<Notification>();
}

@if (notifications.Any())
{
    foreach (var notification in notifications)
    {
        TimeSpan time = DateTime.UtcNow.Subtract(notification.NotificationDate);
        string displayTxt = time switch
        {
            var t when t.TotalDays >= 1 => $"{(int)t.TotalDays}d ago",
            var t when t.TotalHours >= 1 => $"{(int)t.TotalHours}h ago",
            var t when t.TotalMinutes >= 1 => $"{(int)t.TotalMinutes}m ago",
            _ => "Just now"
        };

        string iconName = notification.Type switch
        {
            NotificationType.Like => "heart-outline",
            NotificationType.Comment => "chatbubbles-outline",
            NotificationType.FriendRequest => "person-add-outline",
            NotificationType.Accept => "person-outline",
            _ => "notifications-outline"
        };

        // Sử dụng RelatedId để chuyển hướng
        string redirectUrl = notification.Type switch
        {
            NotificationType.FriendRequest => Url.Action("Index", "FriendRequest") ?? "#",
            NotificationType.Accept => Url.Action("Index", "FriendRequest") ?? "#",
            // Giả định các loại thông báo khác liên quan đến Post/Content
            _ => Url.Action("Details", "Home", new { postId = notification.RelatedId }) ?? "#"
        };

        // 3. Hiển thị thông báo
        // Màu nền nổi bật khi CHƯA ĐỌC (!notification.IsRead)
        <div class="relative flex items-center gap-3 p-2 duration-200 rounded-xl pr-10 hover:bg-secondery @(!notification.IsRead ? "bg-teal-500/5" : "")"
             onclick="window.setNotificationAsRead(@notification.Id); window.location.href = '@redirectUrl';"
             id="notification-item-@notification.Id"
             style="cursor: pointer;">

            @* Hình ảnh Đại diện (Avatar) *@
            <div class="relative w-12 h-12 shrink-0">
                <img src="@(string.IsNullOrEmpty(notification.ProfilePictureUrl) ? Url.Content("~/images/avatar/user.png") : notification.ProfilePictureUrl)"
                     alt="Avatar" class="w-full h-full rounded-full object-cover">
            </div>

            <div class="flex-1 min-w-0">
                <p class="text-sm">
                    <a href="@redirectUrl">
                        @if (!notification.IsRead)
                        {
                            <b class="font-bold mr1">
                                @notification.Message
                            </b>
                        }
                        else
                        {
                            @notification.Message
                        }
                    </a>
                </p>
                <div class="text-xs text-gray-500 mt-1.5 flex items-center gap-2">
                    <ion-icon name="@iconName" class="text-base"></ion-icon>
                    <span>@displayTxt</span>
                </div>
            </div>

            @if (!notification.IsRead)
            {
                <div class="absolute top-2 right-2 w-2 h-2 bg-red-600 rounded-full shrink-0"
                     title="Thông báo chưa đọc">
                </div>
            }

        </div>
    }
}
else
{
}