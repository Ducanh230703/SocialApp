<!DOCTYPE html>
<html>
<head>
    <title>SignalR API Integration</title>
</head>
<body>
    <h1>Tin nhắn từ API: <span id="message">Chưa có tin nhắn</span></h1>
    <h1>Số lần Click: <span id="clickCount">0</span></h1>
    <button id="simulateClickButton">Simulate API Click</button>

    <script src="https://unpkg.com/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const messageSpan = document.getElementById('message');
        const clickCountSpan = document.getElementById('clickCount');
        const simulateClickButton = document.getElementById('simulateClickButton');

        // URL của SignalR Hub trên API của bạn
        // Thay đổi cổng nếu API của bạn chạy trên cổng khác (ví dụ: 7001 cho HTTPS, 5001 cho HTTP)
        const hubUrl = "https://localhost:7024/chathub";

        const connection = new signalR.HubConnectionBuilder()
            .withUrl(hubUrl)
            .build();

        // Lắng nghe sự kiện "ReceiveMessage" từ Hub
        connection.on("ReceiveMessage", (user, message) => {
            messageSpan.textContent = `${user}: ${message}`;
        });

        // Lắng nghe sự kiện "ReceiveClickCount" từ Hub
        connection.on("ReceiveClickCount", (count) => {
            clickCountSpan.textContent = count;
        });

        // Xử lý sự kiện click để gọi API
        simulateClickButton.addEventListener('click', async () => {
            try {
                // Gọi một endpoint trong API của bạn để mô phỏng sự kiện
                const response = await fetch('https://localhost:7024/Values/simulateClick'); // URL của API Controller
                const result = await response.text();
                console.log(result);
            } catch (error) {
                console.error("Error calling API:", error);
            }
        });

        connection.start()
            .then(() => console.log("Connected to SignalR Hub on API!"))
            .catch(err => console.error("Error connecting to SignalR Hub:", err.toString()));

        // Hàm để gọi API gửi tin nhắn (ví dụ từ Console hoặc một form)
        async function sendMessageViaApi(user, text) {
            try {
                const response = await fetch('https://localhost:7024/Values/sendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user, text })
                });
                const result = await response.text();
                console.log(result);
            } catch (error) {
                console.error("Error sending message via API:", error);
            }
        }

        // Bạn có thể gọi hàm này từ console của trình duyệt để kiểm tra:
        // sendMessageViaApi("Alice", "Hello from client console!");
    </script>
</body>
</html>