@using System.Security.Claims;
@using Models.ViewModel.Friend;
@model FriendShipVM;

<main id="site__main" class="2xl:ml-[--w-side] xl:ml-[--w-side-sm] p-2.5 h-[calc(100vh-var(--m-top))] mt-[--m-top]">

    <div style="width: 850px">

        @* Phần Bạn bè của tôi *@
        @if (Model.Friend.TotalCount > 0)
        {
            <div class="sm:my-6 my-3 flex items-center justify-between">
                <div>
                    <h2 class="text-lg text-base font-semibold text-black">Bạn bè của tôi</h2>
                    <p class="font-normal text-sm text-gray-500 leading-6"> Mạng lưới cá nhân của bạn bè và người quen. Kết nối, chia sẻ và giữ liên lạc với những người quan trọng đối với bạn.</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2" id="myFriendsContainer">
                @foreach (var _friendship in Model.Friend.Data)
                {
                    var friend = _friendship;
                    <div class="flex md:items-center space-x-4 p-4 rounded-md box" id="friend-item-@friend.StatusID">
                        <div class="w-14 h-14 flex-shrink-0 rounded-lg relative">
                            <img src="@(string.IsNullOrEmpty(friend.ProfilePictureUrl) ? Url.Content("~/images/avatar/user.png") : friend.ProfilePictureUrl)"
                                 class="absolute w-full h-full inset-0 rounded-md object-cover shadow-sm"
                                 alt="@(friend.FullName ?? "Người dùng")" /> @* Thêm alt tag *@@* Thêm alt tag *@@* Thêm alt tag *@
                        </div>
                        <div class="flex-1">
                            <a href="/User/Details?userId=@friend.UserID" class="text-base font-semibold capitalize text-black">@friend.FullName</a>
                        </div>
                        <form class="ajax-friend-action-form" data-success-action="remove" data-item-id="@friend.StatusID" method="post">
                            <input type="hidden" name="ID" value="@friend.StatusID" />
                            <input type="hidden" name="Status" value="@((int)-1)" />
                            <button type="submit" class="button bg-red-soft text-red gap-1 max-md:hidden">
                                <ion-icon name="remove-circle-outline" class="text-xl -ml-1"></ion-icon> Xóa
                            </button>
                        </form>
                    </div>
                }
            </div>

            @if (Model.Friend.TotalCount > Model.Friend.Data.Count())
            {
                <div class="flex justify-center mt-4">
                    <button class="button soft gray load-more-button" data-section="myFriends" data-current-page="1" data-page-size="@Model.Friend.PageSize" data-total-count="@Model.Friend.TotalCount" data-loaded-count="@Model.Friend.Data.Count()">
                        Tải thêm Bạn bè của tôi
                    </button>
                </div>
            }
        }

        @* Phần Yêu cầu đã nhận *@
        @if (Model.FriendRequestsReceived.TotalCount > 0)
        {
            <div class="sm:my-6 my-3 flex items-center justify-between">
                <div>
                    <h2 class="text-lg text-base font-semibold text-black">Yêu cầu đã nhận</h2>
                    <p class="font-normal text-sm text-gray-500 leading-6">Xem ai muốn kết nối với bạn! Xem xét và phản hồi các yêu cầu kết bạn đến để mở rộng vòng kết nối của bạn.</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2" id="receivedRequestsContainer">
                @foreach (var request in Model.FriendRequestsReceived.Data)
                {
                    <div class="flex md:items-center space-x-4 p-4 rounded-md box" id="request-item-@request.StatusID">
                        <div class="w-14 h-14 flex-shrink-0 rounded-lg relative">
                            <img src="@(string.IsNullOrEmpty(request.ProfilePictureUrl) ? Url.Content("~/images/avatar/user.png") : request.ProfilePictureUrl)"
                                 class="absolute w-full h-full inset-0 rounded-md object-cover shadow-sm"
                                 alt="@(request.FullName ?? "Người dùng")" /> @* Thêm alt tag *@@* Thêm alt tag *@@* Thêm alt tag *@
                        </div>
                        <div class="flex-1">
                            <a href="/User/Details?userId =@request.UserID" class="text-base font-semibold capitalize text-black">@request.FullName</a>
                        </div>
                        <form class="ajax-friend-action-form" data-success-action="hide" data-item-id="@request.StatusID" method="post">
                            <input type="hidden" name="ID" value="@request.StatusID" />
                            <input type="hidden" name="Status" value="@((int)-1)" />
                            <button type="submit" class="button bg-red-soft text-red gap-1 max-md:hidden">
                                <ion-icon name="remove-circle-outline" class="text-xl -ml-1"></ion-icon> Từ chối
                            </button>
                        </form>
                        <form class="ajax-friend-action-form" data-success-action="hide" data-item-id="@request.StatusID"
                              action="/FriendRequest/FriendAnswer" method="post">
                            @* Đã đổi href thành action cho form submit *@
                            <input type="hidden" name="ID" value="@request.StatusID" />
                            <input type="hidden" name="Status" value="@((int)1)" />
                            <button type="submit" class="button bg-primary-soft text-primary gap-1 max-md:hidden">
                                <ion-icon name="checkbox-outline" class="text-xl -ml-1"></ion-icon> Chấp nhận
                            </button>
                        </form>
                    </div>
                }
            </div>

            @if (Model.FriendRequestsReceived.TotalCount > Model.FriendRequestsReceived.Data.Count())
            {
                <div class="flex justify-center mt-4">
                    <button class="button soft gray load-more-button" data-section="receivedRequests" data-current-page="1" data-page-size="@Model.FriendRequestsReceived.PageSize" data-total-count="@Model.FriendRequestsReceived.TotalCount" data-loaded-count="@Model.FriendRequestsReceived.Data.Count()">
                        Tải thêm Yêu cầu đã nhận
                    </button>
                </div>
            }
        }


        @* Phần Lời mời đang chờ *@
        @if (Model.FriendRequestsSent.TotalCount > 0)
        {
            <div class="sm:my-6 my-3 flex items-center justify-between">
                <div>
                    <h2 class="text-lg text-base font-semibold text-black">Lời mời đang chờ</h2>
                    <p class="font-normal text-sm text-gray-500 leading-6">Theo dõi các yêu cầu kết bạn bạn đã gửi. Xem ai chưa phản hồi và quản lý các lời mời đang chờ của bạn.</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2" id="sentRequestsContainer">
                @foreach (var request in Model.FriendRequestsSent.Data)
                {
                    <div class="flex md:items-center space-x-4 p-4 rounded-md box" id="request-item-@request.StatusID">
                        <div class="w-14 h-14 flex-shrink-0 rounded-lg relative">
                            <img src="@(string.IsNullOrEmpty(request.ProfilePictureUrl) ? Url.Content("~/images/avatar/user.png") : request.ProfilePictureUrl)"
                                 class="absolute w-full h-full inset-0 rounded-md object-cover shadow-sm"
                                 alt="@(request.FullName ?? "Người dùng")" /> @* Thêm alt tag *@@* Thêm alt tag *@@* Thêm alt tag *@
                        </div>
                        <div class="flex-1">
                            <a href="/User/Details?userId =@request.UserID" class="text-base font-semibold capitalize text-black">@request.FullName</a>
                        </div>
                        <form class="ajax-friend-action-form" data-success-action="hide" data-item-id="@request.StatusID"
                              asp-controller="FriendRequest" asp-action="FriendAnswer" method="post">
                            <input type="hidden" name="ID" value="@request.StatusID" />
                            <input type="hidden" name="Status" value="@((int)-1)" />
                            <button type="submit" class="button text-primary gap-1 max-md:hidden">
                                <ion-icon name="remove-circle-outline" class="text-xl -ml-1"></ion-icon> Hủy
                            </button>
                        </form>
                    </div>
                }
            </div>

            @if (Model.FriendRequestsSent.TotalCount > Model.FriendRequestsSent.Data.Count())
            {
                <div class="flex justify-center mt-4">
                    <button class="button soft gray load-more-button" data-section="sentRequests" data-current-page="1" data-page-size="@Model.FriendRequestsSent.PageSize" data-total-count="@Model.FriendRequestsSent.TotalCount" data-loaded-count="@Model.FriendRequestsSent.Data.Count()">
                        Tải thêm Lời mời đang chờ
                    </button>
                </div>
            }
        }
    </div>
</main>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Khởi tạo: Lưu trữ text ban đầu của nút để khôi phục sau khi xử lý
            $('form.ajax-friend-action-form button[type="submit"]').each(function() {
                $(this).data('original-text', $(this).text());
            });

            $(document).on('submit', 'form.ajax-friend-action-form', function (e) {
                e.preventDefault(); // Ngăn chặn form submit truyền thống (reload trang)

                const $form = $(this);
                const actionUrl = $form.attr('action') || "/FriendRequest/FriendAnswer"; // Sử dụng action của form nếu có, nếu không thì dùng mặc định
                const successAction = $form.data('success-action'); // 'remove' hoặc 'hide'
                const itemId = $form.data('item-id'); // StatusID (FriendRequestID)

                // Lấy dữ liệu từ input hidden
                const requestData = {
                    ID: parseInt($form.find('input[name="ID"]').val()), // Đảm bảo là số nguyên
                    Status: parseInt($form.find('input[name="Status"]').val()) // Đảm bảo là số nguyên
                };

                const $submitButton = $form.find('button[type="submit"]');

                $submitButton.prop('disabled', true);
                // Giữ lại text gốc để khôi phục
                const originalText = $submitButton.data('original-text');
                $submitButton.text('Đang xử lý...');

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        if (response.status === 1) {
                            // Xử lý thành công
                            if (successAction === 'remove' || successAction === 'hide') {
                                // Tìm item cha để ẩn/xóa, ID có thể là friend-item-X hoặc request-item-X
                                $(`#friend-item-${itemId}, #request-item-${itemId}`).fadeOut(300, function() {
                                    $(this).remove();
                                    // Sau khi xóa thành công, cần cập nhật số lượng TotalCount và LoadedCount trong các nút Load More
                                    updateLoadMoreCounts(successAction === 'remove' ? 'myFriends' : 'receivedRequests');
                                });
                            }
                            console.log("Thành công:", response.mess);
                            // Có thể thêm thông báo thành công cho người dùng ở đây
                        } else {
                            alert('Lỗi: ' + response.mess);
                            console.error("Lỗi API:", response.mess);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi gửi form AJAX:", status, error, xhr.responseText);
                        let errorMessage = "Đã xảy ra lỗi. Vui lòng thử lại.";
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            if (errorResponse && errorResponse.message) {
                                errorMessage = errorResponse.message;
                            } else if (errorResponse && errorResponse.title) {
                                errorMessage = errorResponse.title;
                            }
                        } catch (e) {
                            // Bỏ qua lỗi parsing nếu response không phải JSON
                        }
                        alert(errorMessage);
                    },
                    complete: function() {
                        // Đảm bảo nút được bật lại sau khi request hoàn tất và khôi phục text gốc
                        $submitButton.prop('disabled', false).text(originalText);
                    }
                });
            });

            // Hàm này dùng để cập nhật số lượng TotalCount trong nút Load More sau khi một item bị xóa/ẩn
            function updateLoadMoreCounts(section) {
                const $button = $(`.load-more-button[data-section="${section}"]`);
                if ($button.length) {
                    let totalCount = parseInt($button.data('total-count'));
                    let loadedCount = parseInt($button.data('loaded-count'));

                    if (totalCount > 0) {
                        $button.data('total-count', totalCount - 1);
                        if (loadedCount > 0) {
                            $button.data('loaded-count', loadedCount - 1);
                        }
                        // Nếu LoadedCount mới >= TotalCount mới, ẩn nút Load More
                        if ($button.data('loaded-count') >= $button.data('total-count')) {
                            $button.hide();
                        }
                    }
                }
            }
        });

        // =========================================================================================
        // LOGIC TẢI THÊM BẰNG FETCH API (không dùng jQuery)
        // =========================================================================================

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.load-more-button').forEach(button => {
                button.addEventListener('click', async function () {
                    let currentPage = parseInt(this.dataset.currentPage);
                    const pageSize = parseInt(this.dataset.pageSize);
                    const totalCount = parseInt(this.dataset.totalCount);
                    let loadedCount = parseInt(this.dataset.loadedCount);
                    const section = this.dataset.section;

                    currentPage++;

                    let controllerActionUrl = '';
                    let containerId = '';
                    let originalText = this.textContent; // Lưu text gốc

                    // Xác định URL của Controller action dựa trên section
                    switch (section) {
                        case 'myFriends':
                            controllerActionUrl = `/FriendRequest/LoadMoreFriend`; // Gọi trực tiếp Controller action LoadMoreFriend
                            containerId = 'myFriendsContainer';
                            break;
                        case 'receivedRequests':
                            controllerActionUrl = `/FriendRequest/LoadMoreReceivedRequests`; // Cần action này trong Controller
                            containerId = 'receivedRequestsContainer';
                            break;
                        case 'sentRequests':
                            controllerActionUrl = `/FriendRequest/LoadMoreSentRequests`; // Cần action này trong Controller
                            containerId = 'sentRequestsContainer';
                            break;
                        default:
                            console.error('Lỗi: Phần tải thêm không xác định:', section);
                            return;
                    }

                    const fullUrl = `${controllerActionUrl}?pageNumber=${currentPage}&pageSize=${pageSize}`;

                    this.disabled = true;
                    this.textContent = 'Đang tải...';

                    try {
                        const response = await fetch(fullUrl);

                        if (!response.ok) {
                            let errorMessage = `Lỗi HTTP! status: ${response.status}`;
                            try {
                                const errorResponse = await response.json();
                                if (errorResponse && errorResponse.status === 0 && errorResponse.message === "Chưa xác thực") {
                                    alert("Bạn chưa xác thực. Vui lòng đăng nhập lại.");
                                    window.location.href = "/Account/Login";
                                    return;
                                }
                                errorMessage = errorResponse.message || 'Lỗi không xác định';
                            } catch (e) {
                                // Không phải JSON
                            }
                            throw new Error(errorMessage);
                        }

                        const newItems = await response.json();

                        const container = document.getElementById(containerId);
                        if (container) {
                            if (newItems.length > 0) {
                                newItems.forEach(item => {
                                    const friendHtml = createFriendItemHtml(item, section);
                                    container.insertAdjacentHTML('beforeend', friendHtml);
                                    loadedCount++;
                                });
                            } else {
                                console.log("Không có thêm dữ liệu.");
                            }

                            // Cập nhật thuộc tính của nút
                            this.dataset.currentPage = currentPage;
                            this.dataset.loadedCount = loadedCount;

                            if (loadedCount >= totalCount) {
                                this.style.display = 'none'; // Ẩn nút nếu đã tải hết
                            } else {
                                this.disabled = false;
                                this.textContent = `Tải thêm ${section === 'myFriends' ? 'Bạn bè của tôi' : section === 'receivedRequests' ? 'Yêu cầu đã nhận' : 'Lời mời đang chờ'}`;
                            }
                        }

                    } catch (error) {
                        console.error('Lỗi khi tải thêm mục:', error);
                        alert(`Không thể tải thêm. Vui lòng thử lại. Lỗi: ${error.message}`);
                        this.disabled = false;
                        this.textContent = originalText;
                    }
                });
            });

            // Hàm tạo HTML cho item bạn bè/yêu cầu (dùng chung cho cả Razor và AJAX)
            function createFriendItemHtml(item, section) {
                const defaultAvatar = '/images/avatar/user.png';
                // Đảm bảo tên thuộc tính khớp với JSON (thường là camelCase trong JS)
                const profilePictureUrl = item.profilePictureUrl && item.profilePictureUrl !== '' ? item.profilePictureUrl : defaultAvatar;
                const itemId = item.statusID; // Sử dụng StatusID để định danh request/friendship

                let actionsHtml = '';
                const baseItemTag = section === 'myFriends' ? 'friend-item' : 'request-item';

                if (section === 'myFriends') {
                    actionsHtml = `
                        <form class="ajax-friend-action-form" data-success-action="remove" data-item-id="${itemId}" method="post">
                            <input type="hidden" name="ID" value="${itemId}" />
                            <input type="hidden" name="Status" value="-1" />
                            <button type="submit" class="button bg-red-soft text-red gap-1 max-md:hidden" data-original-text="Xóa">
                                <ion-icon name="remove-circle-outline" class="text-xl -ml-1"></ion-icon> Xóa
                            </button>
                        </form>
                    `;
                } else if (section === 'receivedRequests') {
                    actionsHtml = `
                        <form class="ajax-friend-action-form" data-success-action="hide" data-item-id="${itemId}" method="post">
                            <input type="hidden" name="ID" value="${itemId}" />
                            <input type="hidden" name="Status" value="-1" />
                            <button type="submit" class="button bg-red-soft text-red gap-1 max-md:hidden" data-original-text="Từ chối">
                                <ion-icon name="remove-circle-outline" class="text-xl -ml-1"></ion-icon> Từ chối
                            </button>
                        </form>
                        <form class="ajax-friend-action-form" data-success-action="hide" data-item-id="${itemId}" action="/FriendRequest/FriendAnswer" method="post">
                            <input type="hidden" name="ID" value="${itemId}" />
                            <input type="hidden" name="Status" value="1" />
                            <button type="submit" class="button bg-primary-soft text-primary gap-1 max-md:hidden" data-original-text="Chấp nhận">
                                <ion-icon name="checkbox-outline" class="text-xl -ml-1"></ion-icon> Chấp nhận
                            </button>
                        </form>
                    `;
                } else if (section === 'sentRequests') {
                    actionsHtml = `
                        <form class="ajax-friend-action-form" data-success-action="hide" data-item-id="${itemId}" action="/FriendRequest/FriendAnswer" method="post">
                            <input type="hidden" name="ID" value="${itemId}" />
                            <input type="hidden" name="Status" value="-1" />
                            <button type="submit" class="button text-primary gap-1 max-md:hidden" data-original-text="Hủy">
                                <ion-icon name="remove-circle-outline" class="text-xl -ml-1"></ion-icon> Hủy
                            </button>
                        </form>
                    `;
                }

                return `
                    <div class="flex md:items-center space-x-4 p-4 rounded-md box" id="${baseItemTag}-${itemId}">
                        <div class="w-14 h-14 flex-shrink-0 rounded-lg relative">
                            <img src="${profilePictureUrl}"
                                 class="absolute w-full h-full inset-0 rounded-md object-cover shadow-sm"
                                 alt="${item.fullName || 'Người dùng'}" />
                        </div>
                        <div class="flex-1">
                            <a href="/User/Details?userId =${item.userID}" class="text-base font-semibold capitalize text-black">${item.fullName}</a>
                        </div>
                        ${actionsHtml}
                    </div>
                `;
            }
        });
    </script>
}