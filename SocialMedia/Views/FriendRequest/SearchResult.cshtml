@using Models.ReponseModel
@using Models.ViewModel.Friend
@model List<SearchResult>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Kết quả tìm kiếm bạn bè";
    var initialQuery = ViewData["SearchQuery"]?.ToString();
    var initialPageNumber = (int)(ViewData["PageNumber"] ?? 1);
    var initialPageSize = (int)(ViewData["PageSize"] ?? 5);

}

<main id="site__main" class="2xl:ml-[--w-side] xl:ml-[--w-side-sm] p-2.5 h-[calc(100vh-var(--m-top))] mt-[--m-top]">
    <div class="container p-4" style="width:950px">
        <h1 class="text-3xl font-bold mb-6">Tìm kiếm bạn bè</h1>

        <div class="search-form-container mb-6">
            <form id="search-page-form" class="flex gap-2">
                <input type="text" name="query" placeholder="Tìm kiếm bạn bè..."
                       class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                       value="@initialQuery" />
                <button type="submit"
                        class="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Tìm kiếm
                </button>
            </form>
        </div>
        <div class="flex justify-center items-center gap-4 mb-6">
            <button onclick="changeSearchType('friend')"
                    class="px-4 py-2 rounded-full text-sm font-semibold transition
                   bg-blue-500 text-white hover:bg-blue-600 focus:ring-2 focus:ring-blue-400"
                    id="friendBtn">
                👥 Người dùng
            </button>

            <button onclick="changeSearchType('group')"
                    class="px-4 py-2 rounded-full text-sm font-semibold transition
                   bg-gray-200 hover:bg-gray-300 text-gray-800 focus:ring-2 focus:ring-gray-300"
                    id="groupBtn">
                🏘️ Nhóm
            </button>
        </div>
        <div id="search-results-main-container" class="mt-4">
            @if (Model != null && Model.Any())
            {
                <h2 class="text-2xl font-bold mb-4" id="search-results-title">Kết quả tìm kiếm cho: "@initialQuery"</h2>
                await Html.RenderPartialAsync("~/Views/FriendRequest/_SearchResult.cshtml", Model);
            }
            else if (!string.IsNullOrEmpty(initialQuery))
            {
                <div class="bg-white rounded-xl shadow-sm p-4 text-center text-gray-500">
                    Không tìm thấy kết quả nào cho "@initialQuery".
                </div>
            }   
            else
            {
                <div class="bg-white rounded-xl shadow-sm p-4 text-center text-gray-500">
                    Vui lòng nhập từ khóa để tìm kiếm bạn bè.
                    @if (string.IsNullOrEmpty(Context.Request.Cookies["AuthToken"]))
                    {
                        <p class="mt-2">Bạn cần <a href="/Authentication/Login" class="text-blue-500 hover:underline">đăng nhập</a> để sử dụng tính năng tìm kiếm.</p>
                    }
                </div>
            }
        </div>
    </div>
</main>
@section Scripts {
    <script>
        let currentSearchType = "friend";

        document.addEventListener("DOMContentLoaded", function () {
            const searchPageForm = document.getElementById("search-page-form");
            const searchResultsMainContainer = document.getElementById("search-results-main-container");
        const searchInput = document.querySelector("#search-page-form input[name='query']");
                    const friendBtn = document.getElementById("friendBtn");
            const groupBtn = document.getElementById("groupBtn");

            // Gửi request khi nhấn Enter hoặc nút "Tìm kiếm"
            searchPageForm.addEventListener("submit", function (e) {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query) return alert("Vui lòng nhập từ khóa tìm kiếm.");
                doSearch(query);
            });


            // Khi chuyển loại tìm kiếm (Người dùng / Nhóm)
            window.changeSearchType = function (type) {
                currentSearchType = type;
                updateButtonStyles();
                const query = searchInput.value.trim();
                if (query) doSearch(query);
            };

            // Hàm chung gọi request
            function doSearch(query) {
                if (currentSearchType === "group") searchGroup(query);
                else searchFriend(query);
            }

            function updateButtonStyles() {
                const active = ["bg-blue-500", "text-white"];
                const inactive = ["bg-gray-200", "text-gray-800"];
                if (currentSearchType === "friend") {
                    friendBtn.classList.add(...active);
                    friendBtn.classList.remove(...inactive);
                    groupBtn.classList.add(...inactive);
                    groupBtn.classList.remove(...active);
                } else {
                    groupBtn.classList.add(...active);
                    groupBtn.classList.remove(...inactive);
                    friendBtn.classList.add(...inactive);
                    friendBtn.classList.remove(...active);
                }
            }

            // ======== Gọi API ========
            function searchFriend(query) {
                fetch(`/FriendRequest/SearchResult?stringSearch=${encodeURIComponent(query)}`, {
                    method: "GET",
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
                    .then(res => res.ok ? res.text() : Promise.reject("Không thể tải kết quả người dùng."))
                    .then(html => {
                        searchResultsMainContainer.innerHTML = `
                            <h2 class="text-2xl font-bold mb-4">Kết quả tìm kiếm người dùng cho: "${query}"</h2>
                            ${html}
                        `;
                    })
                    .catch(err => searchResultsMainContainer.innerHTML = `<div class="text-center text-red-500">${err}</div>`);
            }

            function searchGroup(query) {
                fetch(`/Group/SearchGroup?query=${encodeURIComponent(query)}`, {
                    method: "GET",
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
                    .then(res => res.ok ? res.text() : Promise.reject("Không thể tải kết quả nhóm."))
                    .then(html => {
                        searchResultsMainContainer.innerHTML = `
                            <h2 class="text-2xl font-bold mb-4">Kết quả tìm kiếm nhóm cho: "${query}"</h2>
                            ${html}
                        `;
                    })
                    .catch(err => searchResultsMainContainer.innerHTML = `<div class="text-center text-red-500">${err}</div>`);
            }
        });
    </script>
}
