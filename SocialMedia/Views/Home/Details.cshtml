@using Models.ViewModel.Home
<main id="site__main" class="2xl:ml-[--w-side] xl:ml-[--w-side-sm] p-2.5 min-h-[calc(100vh-var(--m-top))] mt-[--m-top]">
    <div style="width:700px" id="js-oversized">
        <div class="w-full h-full">
            <partial name="_Post" model="Model" view-data='new ViewDataDictionary(ViewData) { ["ShowAllComment"] = true, ["LoggedInUserId"] = ViewBag.LoggedInUserId }' />
            <partial name="_PostDeleteConfirmation" />
        </div>
    </div>
</main>
<partial name="_EditStatus" model="new PostEditVM()" />
<script>
    // Hàm hiển thị thông báo SweetAlert2 (được lấy từ file trước)
    function showSwalAlert(message, isSuccess, callback = null) {
        Swal.fire({
            icon: isSuccess ? 'success' : 'error',
            title: isSuccess ? 'Thành công' : 'Thất bại',
            text: message,
            confirmButtonText: 'Đóng',
            // Tự động gọi callback (thường là reload/redirect) sau khi đóng popup nếu thành công
            didClose: () => {
                if (callback) {
                    callback();
                }
            }
        });
    }

    let loggedInUserId = @(ViewBag.LoggedInUserId != null ? ViewBag.LoggedInUserId.ToString() : "null");

    document.querySelectorAll('.add-comment-form').forEach(form => {
        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            const formData = new FormData(this);
            const postId = formData.get('postId');
            const content = formData.get('content');
            const textarea = this.querySelector('textarea[name="content"]');

            if (!content || content.trim() === '') {
                // THÔNG BÁO THẤT BẠI: Bình luận trống
                showSwalAlert("Bình luận không được để trống!", false);
                return;
            }

            try {
                await connection.invoke("AddComment", parseInt(postId), content);
                textarea.value = '';
            } catch (err) {
                console.error("Failed to add comment:", err);
                // THÔNG BÁO THẤT BẠI: Lỗi API/SignalR
                showSwalAlert("Có lỗi xảy ra khi thêm bình luận.", false);
            }
        });
    });

    document.addEventListener('submit', function(e) {
        if (e.target && e.target.classList.contains('remove-comment-form')) {
            e.preventDefault();

            const form = e.target;
            const commentId = form.getAttribute('data-comment-id');

            const actionUrl = '/Comment/RemovePostComment?CommentId=' + commentId;

            if (!commentId || isNaN(parseInt(commentId))) {
                // THÔNG BÁO THẤT BẠI: Không tìm thấy ID
                showSwalAlert("Lỗi: Không tìm thấy ID bình luận để xóa.", false);
                return;
            }

            fetch(actionUrl, {
                method: 'DELETE',
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 1 || data.success === true) {
                        // THÔNG BÁO THÀNH CÔNG: Xóa bình luận
                        showSwalAlert(data.message || "Xóa bình luận thành công.", true, () => {
                            // Callback để xóa element sau khi đóng popup
                            form.closest('.flex.items-start.gap-3.relative')?.remove();
                        });
                    } else {
                        // THÔNG BÁO THẤT BẠI: Lỗi logic
                        showSwalAlert(data.message || "Không thể xóa bình luận.", false);
                    }
                })
                .catch(error => {
                    console.error("Lỗi:", error);
                    // THÔNG BÁO THẤT BẠI: Lỗi hệ thống/kết nối
                    showSwalAlert("Đã xảy ra lỗi khi gửi yêu cầu xóa bình luận.", false);
                });
        }
    });


    document.addEventListener('click', async function (event) {
        const button = event.target.closest('.like-button');

        if (button) {
            event.preventDefault();

            const postId = button.getAttribute('data-post-id');
            const isLiked = button.classList.contains('text-red-500');
            const likeCountElement = button.closest('.flex.items-center.gap-4')?.querySelector('a:last-child');
            let currentLikes = parseInt(likeCountElement?.textContent) || 0;

            const icon = button.querySelector('ion-icon');
            // Cập nhật UI trước khi gọi API
            if (isLiked) {
                button.classList.remove('text-red-500');
                icon.name = 'heart-outline';
                if (likeCountElement) likeCountElement.textContent = currentLikes > 0 ? currentLikes - 1 : 0;
            } else {
                button.classList.add('text-red-500');
                icon.name = 'heart';
                if (likeCountElement) likeCountElement.textContent = currentLikes + 1;
            }

            try {
                const formdata = new FormData();
                formdata.append("postId", postId);
                const response = await fetch(`/Like/${isLiked ? 'Unlike' : 'LikePost'}`, {
                    method: 'POST',
                    body: formdata
                });
                const result = await response.json();
                if (result.status !== 1) {
                    // Hoàn tác UI nếu API thất bại
                    if (isLiked) {
                        button.classList.add('text-red-500');
                        icon.name = 'heart';
                        if (likeCountElement) likeCountElement.textContent = currentLikes;
                    } else {
                        button.classList.remove('text-red-500');
                        icon.name = 'heart-outline';
                        if (likeCountElement) likeCountElement.textContent = currentLikes;
                    }
                    // THÔNG BÁO THẤT BẠI: Lỗi logic like/unlike
                    showSwalAlert(result.message, false);
                }
            } catch (error) {
                console.error("Lỗi khi gửi yêu cầu:", error);
                // Hoàn tác UI nếu lỗi kết nối
                if (isLiked) {
                    button.classList.add('text-red-500');
                    icon.name = 'heart';
                    if (likeCountElement) likeCountElement.textContent = currentLikes;
                } else {
                    button.classList.remove('text-red-500');
                    icon.name = 'heart-outline';
                    if (likeCountElement) likeCountElement.textContent = currentLikes;
                }
                // THÔNG BÁO THẤT BẠI: Lỗi kết nối
                showSwalAlert("Lỗi kết nối. Vui lòng thử lại.", false);
            }
        }
    });

    window.openPostDeleteConfirmation = function (postId) {
        document.getElementById('deleteConfirmationPostId').value = postId;
        UIkit.modal(document.getElementById('postDeleteDialog')).show();
    };

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
        const postId = document.getElementById('deleteConfirmationPostId').value;
        this.disabled = true;

        try {
            const response = await fetch(`/Home/DeletePost?PostId=${postId}`, {
                method: 'DELETE',
            });
            const result = await response.json();

            // Ẩn modal xác nhận UIkit ngay lập tức
            UIkit.modal(document.getElementById('postDeleteDialog')).hide();

            if (result.status === 1) {
                // THÔNG BÁO THÀNH CÔNG: Xóa bài viết
                showSwalAlert(result.message, true, () => {
                    // Callback để xóa element sau khi đóng popup
                    document.getElementById(`post-${postId}`).remove();
                });
            } else {
                // THÔNG BÁO THẤT BẠI: Lỗi logic
                showSwalAlert(result.message, false);
            }
        } catch (error) {
            console.error("Lỗi khi xóa bài viết:", error);
            // Ẩn modal xác nhận UIkit ngay lập tức
            UIkit.modal(document.getElementById('postDeleteDialog')).hide();
            // THÔNG BÁO THẤT BẠI: Lỗi hệ thống
            showSwalAlert("Đã xảy ra lỗi khi xóa bài viết.", false);
        } finally {
            this.disabled = false;
        }
    });

    connection.on("ReceiveComment", function (postId, comment) {
        const postElement = document.getElementById(`post-${postId}`);
        if (postElement) {
            const commentsList = postElement.querySelector('.comments-list');
            const newCommentHtml = `
                <div class="flex items-start gap-3 relative new-comment" id="comment-${comment.id}">
                    <img src="${comment.userProfilePictureUrl || '/images/avatar/user.png'}" class="w-6 h-6 mt-1 rounded-full" />
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <span class="text-black font-medium inline-block flex-grow">${comment.userFullName}</span>
                            <small>Just now</small>
                        </div>
                        <p class="mt-0.5">${comment.content}</p>
                        <form class="remove-comment-form" data-comment-id="${comment.id}">
                            <button type="submit" class="text-red-500 text-xs ml-2" title="Remove post comment">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </form>
                    </div>
                </div>
            `;
            commentsList.insertAdjacentHTML('afterbegin', newCommentHtml);
        }
    });
</script>